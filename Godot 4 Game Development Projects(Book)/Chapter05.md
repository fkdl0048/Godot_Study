## 3D 미니골프: 미니골프 코스를 만들며 3D로 뛰어들기

이번 장에서 배울 내용은 다음과 같다.

- 고도의 3D 에디터 탐색하기
- `Node3D`와 그 속성
- 3D 메시 가져오기와 3D 콜리전 모양 사용
- 3D 카메라 사용법
- 조명 및 환경 설정
- PBR 및 머티리얼 소개

### 3D에 대한 소개

고도의 3D는 앞서 사용한 2D와 동일한 씬, 노드, 시그널의 구조를 그대로 따라간다. 하지만 3D만의 새로운 계층의 복잡성과 가능성이 추가된다.

#### 3D 공간에서 방향 지정

프로젝트 상단의 `3D`버튼을 클릭하면 3D 프로젝트 뷰로 볼 수 있다. X(빨강), Y(초록), Z(파랑)축이 보인다. 이 축들이 만나는 지점이 원점이며 좌표는 (0, 0, 0)이다.

3D로 작업을 할 때 항상 발생하는 문제는 애플리케이션마다 방향 정위에 사용하는 규칙이 서로 다르다는 점이다. 고도가 Y가 위인 방향 정위를 사용하므로 축을 볼 때 x가 왼쪽/오른쪽을 가리키고 y는 위/아래를 가리키며 z는 앞/뒤를 가리킨다.

*유니티의 경우 고도와 동일하고, 언리얼의 경우엔 z축이 위/아래, x축이 앞/뒤, y축이 좌/우를 나타낸다. 즉 오른손 좌표계*

알아야 할 또 다른 중요한 사실은 측정 단위로 2D에서는 고도가 모든 것을 픽셀 단위로 측정하므로 화면에 그림을 그릴 때의 측정 기본 단위로도 픽셀이 적합하다. 하지만 3D 공간에서 작업할 때는 픽셀이 그다지 유용하지 않다. 두 오브젝트의 크기가 같더라도 카메라의 기준에서 화면에서 차지하는 넓이가 달라지기 때문에 범용 단위로 측정한다. **고도에서는 3D 공간에서는 미터 단위를 사용한다.**

#### 고도의 3D 에디터

- 마우스 휠 위/아래: 현재 대상 줌인/줌아웃
- 가운데 버튼 + 드래그: 현재 대상을 중심으로 카메라 궤도 돌리기
- Shift + 가운데 버튼 + 드래그: 카메라를 위/아래/좌/우로 패닝
- 오른쪽 버튼 + 드래그: 제자리에서 카메라 회전

*살짝 다른 것 빼고 유니티나 언리얼과 비슷하다.*

뷰포트의 왼쪽 상단 모서리에 있는 원근 레이블을 클릭해 카메라의 시야에 영향을 줄 수도 있다. 여기에는 `Orthogonal`과 `Perspective`가 있다. `Orthogonal`은 3D 공간을 2D로 투영한 것이며, `Perspective`는 실제 3D 공간을 투영한 것이다.

*그래픽스 관련된 내용을 공부하면 이해하기 쉽다.*

#### 3D 오브젝트 추가

모든 2D 노드가 Position과 Rotation 같은 속성을 제공하는 `Node2D`를 상속하듯이 3D 노드는 공간 속성을 제공하는 `Node3D`를 상속한다.

#### 글로벌 공간과 로컬 공간

기본적으로 기즈모 제어는 글로벌 공간에서 작동한다. 이를 변경하기 위해 로컬 공간 모드로 변환하는 T키를 눌러서 로컬 공간에서 작업할 수 있다.

#### 변형

Node3D의 인스펙터를 보면 Transgorm 섹션이 있다. 그 아래 Translation, Rotation, Scale이 있는데, 이들은 모두 2D와 마찬가지로 부모에 상대적이다. 코드에서 노드의 공간 속성을 변경할 때는 해당 노드의 `transform` 속성에 접근하게 되는데, 이는 사실 고도 `Transform3D`오브젝트다. `Transform3D`에는 **origin과 basic라는 2가지 하위 속성이 있다.** origin 속성은 바디의 위치를 나타내며, basis 속성은 바디의 로컬 좌표축을 정의하는 3개의 벡터를 포함한다. 로컬 공간 모드에 있을 때 기즈모의 세 축 화살표를 생각하면 된다.

#### 메시

`Node2D`와 마찬가지로 `Node3D` 노드에는 자체적인 크기나 모습이 없다. 2D에서는 `Sprite2D`를 추가했다면 3D에서는 일반적으로 메시(Mesh)를 추가한다. 메시란, 3차원 모양을 수학적으로 묘사하는 것이며, 꼭지점의 집합으로 구성된다. 꼭지점은 모서리(edge)라는 선으로 연결되며, 모서리 여러 개(최소 3개)가 모여 면(face)을 형성한다.

고도에서는 특정 모델이 없을 때, 직접 만들 수 있는 기능이 있다. `MeshInstance3D` 노드를 자식으로 추가허여 인스펙터에서 Mesh 속성을 살펴보면 사전 정의된 원시 모양(primitive)를 선택할 수 있다.

고도의 권장 메시 형식은 `.gltf`이다.

#### 카메라

방금 만든 정육면체 메시로 씬을 실행해보면 아무것도 보이지 않는다. 3D에서는 씬에 `Camera3D` 노드가 없으면 게임 뷰포트에 아무것도 표시되지 않는다. 카메라를 추가하면 다음과 같은 새 노드가 보일 것이다.

*카메라도 직접 생성한다는 느낌이 조금 새롭기도 하다.*

씬에서 보이는 보라색 피라미드 모양을 카메라의 frustum(절두체)라고 한다. 카메라의 뷰를 나타내며 좁게 또는 넓게 만들어서 카메라의 시야(FOV, Field of View)를 조절할 수 있다. 상단의 삼각형은 카메라의 '위'를 나타낸다.

카메라를 생성한 시점에서 카메라 절두체가 -Z축을 향하고 있다는 점을 본다면 고도의 3D 공간에서 앞쪽 방향이라는 뜻이다. 따라서 오브젝트의 전방 축을 따라 이동하려는 코드를 짤 때는 다음과 같이 `transform.basis`를 사용해야 한다.

```gd
position += -transform.basis.z * speed * delta
```

*생각보다 중요한 개념이라고 생각한다.*

### 프로젝트 설정

에셋을 설정하고, 마찬가지로 입력 추상화인 입력 맵에서 사용할 키를 등록한다. 또한, 사용자가 창 크기를 조절할 때 UI 레이아웃이 흐트러지거나 게임 화면이 왜곡되어 표시될 수 있기에 이를 방지하기 위해서 표시/창 섹션에 스트레치/모드 설정을 viewport로 변경한다.

### 코스 만들기

`Node3D`노드로 Hole이라는 씬을 만들고 저번 프로젝트와 같이 프리팹처럼 공통으로 사용하는 노드와 코드를 포함한 씬을 만들어서 확장한다. 이후 `GridMap`노드를 추가한다.

#### GridMap 이해하기

`GridMap`은 앞서 사용한 `TileMap` 노드의 3D 버전이라고 할 수 있다. 이 노드를 사용하면 메시 모음을 사용해 격자로 배치할 수 있다. 3D로 작동하기 때문에 어떤 방향으로든 메시를 쌓을 수 있다.

